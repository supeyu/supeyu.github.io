<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <title>ç”Ÿæ—¥å¿«ä¹ | ä¸“å±é‚€è¯·å‡½</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome å›¾æ ‡ -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- é«˜å¾·åœ°å›¾APIï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ -->
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=æ‚¨çš„é«˜å¾·åœ°å›¾APIå¯†é’¥"></script>

  <!-- è‡ªå®šä¹‰é…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            birthday: {
              pink: '#FF6B8B',
              yellow: '#FFD166',
              blue: '#06D6A0',
              purple: '#7928CA',
              orange: '#FF8C42'
            },
          },
          fontFamily: {
            happy: ['Comic Sans MS', 'cursive', 'sans-serif'],
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'bounce-slow': 'bounce 4s ease-in-out infinite',
            'spin-slow': 'spin 8s linear infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }
      .bg-gradient-happy {
        background: linear-gradient(135deg, #FF6B8B 0%, #FFD166 50%, #06D6A0 100%);
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        opacity: 0;
        animation: confetti-fall 5s linear infinite;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-100vh) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
      .animate-number {
        counter-reset: num 0;
        animation: count 2s forwards ease-out;
      }
      @keyframes count {
        to { counter-reset: num var(--num); }
      }
      .animate-number::after {
        content: counter(num);
      }
      .music-control {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      /* æ–°å¢ï¼šé‡å¤æ•°æ®æ ·å¼æ ‡è®° */
      .duplicate-item {
        background-color: #fef2f2;
        opacity: 0.7;
      }
      /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
      .touch-scale {
        touch-action: manipulation;
      }
      .mobile-padding {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .mobile-btn {
        min-height: 48px;
        min-width: 48px;
      }
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50 font-happy overflow-x-hidden mobile-padding">
<!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’® - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
<div id="music-controls" class="fixed bottom-6 right-6 z-50 hidden">
  <button id="music-toggle" class="music-control w-16 h-16 rounded-full bg-birthday-pink/80 text-white shadow-lg
              flex items-center justify-center hover:bg-birthday-pink transition-all transform hover:scale-110 touch-scale mobile-btn">
    <i id="music-icon" class="fa fa-music text-2xl"></i>
  </button>
  <div class="music-control absolute bottom-20 right-0 bg-white/80 rounded-lg p-3 shadow-lg hidden" id="volume-slider-container">
    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.7"
           class="w-32 accent-birthday-pink">
  </div>
</div>

<!-- èº«ä»½é€‰æ‹©é¡µé¢ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
<div id="identity-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-happy">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 transform transition-all hover:scale-105 touch-scale">
    <h1 class="text-[clamp(1.5rem,6vw,2.5rem)] font-bold text-birthday-pink text-center mb-8">
      ğŸ‚ ç”Ÿæ—¥é‚€è¯·å‡½ ğŸ‚
    </h1>

    <div class="grid grid-cols-1 gap-6">
      <button id="guest-btn" class="py-5 px-6 rounded-xl bg-birthday-yellow text-white text-xl font-semibold
                  shadow-md hover:bg-birthday-orange transition-all transform hover:scale-105
                  flex items-center justify-center gap-3 touch-scale mobile-btn">
        <i class="fa fa-user text-xl"></i> æˆ‘æ˜¯å—é‚€å®¢äºº
      </button>

      <button id="host-btn" class="py-5 px-6 rounded-xl bg-birthday-purple text-white text-xl font-semibold
                  shadow-md hover:bg-birthday-blue transition-all transform hover:scale-105
                  flex items-center justify-center gap-3 touch-scale mobile-btn">
        <i class="fa fa-key text-xl"></i> æˆ‘æ˜¯é‚€è¯·äºº
      </button>
    </div>

    <!-- é‚€è¯·äººå¯†ç éªŒè¯ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <div id="password-form" class="mt-8 hidden">
      <label class="block text-gray-700 text-lg font-medium mb-2">è¯·è¾“å…¥é‚€è¯·äººå¯†ç ï¼š</label>
      <div class="flex gap-3">
        <input type="password" id="host-password"
               class="flex-1 px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-birthday-pink text-lg"
               placeholder="è¾“å…¥å¯†ç ">
        <button id="verify-password" class="px-6 py-3 bg-birthday-pink text-white rounded-lg hover:bg-birthday-purple transition-all touch-scale mobile-btn">
          éªŒè¯
        </button>
      </div>
      <p id="password-error" class="text-red-500 text-sm mt-2 hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼</p>
    </div>
  </div>
  <div class="absolute bottom-6 text-white text-sm opacity-70">
    ğŸ‰ ç”Ÿæ—¥å¿«ä¹ ğŸ‰
  </div>
</div>

<!-- é‚€è¯·å‡½é¡µé¢ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
<div id="invitation-page" class="min-h-screen p-4 hidden">
  <div id="confetti-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-0"></div>

  <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl overflow-hidden relative z-10 touch-scale">
    <!-- é‚€è¯·å‡½å¤´éƒ¨ -->
    <div class="bg-gradient-to-r from-birthday-pink to-birthday-yellow p-6 text-center text-white">
      <h2 class="text-[clamp(1.3rem,5vw,2rem)] font-bold text-shadow mb-2 animate-bounce-slow">
        äº²çˆ±çš„æœ‹å‹ï¼š
      </h2>
      <p class="text-[clamp(1rem,4vw,1.5rem)] font-semibold">
        è¯šæŒšé‚€è¯·æ‚¨å‚åŠ  <span class="text-birthday-purple animate-pulse-slow">è‹é›¨è¾°</span> çš„ç”Ÿæ—¥æ´¾å¯¹ï¼
      </p>
    </div>

    <!-- é‚€è¯·å‡½å†…å®¹ -->
    <div class="p-5 space-y-6">
      <!-- ç”Ÿæ—¥ä¸»è§’ä¿¡æ¯ -->
      <div class="text-center">
        <div class="inline-block p-4 bg-birthday-yellow/10 rounded-full mb-4 animate-float">
          <i class="fa fa-birthday-cake text-5xl text-birthday-pink"></i>
        </div>
        <h3 class="text-2xl font-bold text-birthday-pink">å¯¿æ˜Ÿï¼šè‹é›¨è¾°</h3>
        <p class="text-gray-600 mt-1">10å²ç”Ÿæ—¥å¿«ä¹ ğŸ‰</p>
      </div>

      <!-- é‚€è¯·ä¿¡æ¯ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
      <div class="bg-gray-50 rounded-xl p-4 border-l-4 border-birthday-yellow">
        <div class="flex items-start gap-3 mb-4">
          <i class="fa fa-calendar text-birthday-pink text-xl mt-1"></i>
          <div>
            <h4 class="font-bold text-lg text-gray-800">æ´¾å¯¹æ—¶é—´</h4>
            <p class="text-gray-600">2025å¹´12æœˆ21æ—¥ æ™šä¸Š18:00</p>
          </div>
        </div>

        <div class="flex items-start gap-3 mb-4">
          <i class="fa fa-map-marker text-birthday-pink text-xl mt-1"></i>
          <div>
            <h4 class="font-bold text-lg text-gray-800">æ´¾å¯¹åœ°ç‚¹</h4>
            <p class="text-gray-600">å¹¸ç¦è·¯88å· æ¬¢ä¹é¤å… 3æ¥¼VIPåŒ…é—´</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <i class="fa fa-heart text-birthday-pink text-xl mt-1"></i>
          <div>
            <h4 class="font-bold text-lg text-gray-800">é‚€è¯·å¯„è¯­</h4>
            <p class="text-gray-600">æœŸå¾…ä¸æ‚¨å…±åº¦ç¾å¥½æ—¶å…‰ï¼Œåˆ†äº«ç”Ÿæ—¥å–œæ‚¦ï¼</p>
          </div>
        </div>
      </div>

      <!-- åœ°å›¾åŒºåŸŸ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
      <div class="rounded-xl overflow-hidden shadow-md h-56 border border-gray-200">
        <div id="map-container" class="w-full h-full"></div>
      </div>

      <!-- å®¢äººä¿¡æ¯æäº¤è¡¨å• - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
      <div class="bg-birthday-blue/10 rounded-xl p-4">
        <h3 class="text-xl font-bold text-birthday-blue mb-4 text-center">
          ğŸ“ å‡ºå¸­ä¿¡æ¯ç¡®è®¤
        </h3>

        <form id="guest-form" class="space-y-5">
          <div>
            <label class="block text-gray-700 font-medium mb-2">æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="guest-name" required
                   class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-birthday-blue text-lg"
                   placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">å‡ºå¸­äººæ•°ï¼š</label>
            <div class="flex items-center gap-4">
              <button type="button" id="decrease-count"
                      class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-all touch-scale mobile-btn">
                <i class="fa fa-minus text-lg"></i>
              </button>

              <span id="attendee-count" class="text-2xl font-bold text-birthday-pink min-w-[50px] text-center">1</span>

              <button type="button" id="increase-count"
                      class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-all touch-scale mobile-btn">
                <i class="fa fa-plus text-lg"></i>
              </button>
            </div>
          </div>

          <button type="submit" class="w-full py-4 bg-birthday-pink text-white rounded-lg text-lg font-semibold
                      hover:bg-birthday-purple transition-all transform hover:scale-105 shadow-md touch-scale mobile-btn">
            ğŸˆ ç¡®è®¤æäº¤å‡ºå¸­ä¿¡æ¯
          </button>
        </form>

        <!-- æäº¤æˆåŠŸæç¤º - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
        <div id="submit-success" class="mt-4 p-4 bg-green-100 text-green-700 rounded-lg text-center hidden">
          <i class="fa fa-check-circle text-xl"></i> æäº¤æˆåŠŸï¼<br>
          è¯·å°†ä»¥ä¸‹é“¾æ¥å‘é€ç»™é‚€è¯·äººï¼š<br>
          <div class="mt-2 p-3 bg-white rounded text-sm break-all select-all" id="share-url"></div>
          <button onclick="copyShareUrl()" class="mt-3 px-4 py-2 bg-birthday-pink text-white rounded text-sm touch-scale mobile-btn">
            å¤åˆ¶é“¾æ¥
          </button>
        </div>

        <!-- é‡å¤æäº¤æç¤º - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
        <div id="submit-duplicate" class="mt-4 p-4 bg-red-100 text-red-700 rounded-lg text-center hidden">
          <i class="fa fa-exclamation-triangle text-xl"></i> æäº¤å¤±è´¥ï¼<br>
          è¯¥å§“åå·²æäº¤è¿‡ï¼Œè¯·å‹¿é‡å¤æäº¤
        </div>

        <!-- æäº¤åŠ è½½æç¤º - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
        <div id="submit-loading" class="mt-4 p-4 bg-gray-100 text-gray-700 rounded-lg text-center hidden">
          <i class="fa fa-spinner fa-spin text-xl mb-2"></i> æ­£åœ¨æäº¤ä¿¡æ¯ï¼Œè¯·ç¨å€™...
        </div>
      </div>
    </div>

    <!-- é¡µè„š -->
    <div class="bg-gray-100 p-4 text-center text-gray-600">
      <p>ğŸ è¯šé‚€å‚åŠ  ğŸ</p>
    </div>
  </div>
</div>

<!-- é‚€è¯·äººæ±‡æ€»é¡µé¢ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
<div id="summary-page" class="min-h-screen p-4 hidden">
  <div class="max-w-md mx-auto">
    <header class="bg-birthday-pink text-white p-4 rounded-xl mb-6 shadow-md">
      <h2 class="text-xl font-bold flex items-center gap-2">
        <i class="fa fa-list-alt"></i> å®¢äººå‡ºå¸­ä¿¡æ¯æ±‡æ€»
      </h2>
      <p class="text-white/80 mt-1 text-sm">å®æ—¶æ›´æ–°çš„å®¢äººå‡ºå¸­æ•°æ®</p>
    </header>

    <!-- åˆ·æ–°æŒ‰é’® - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <button id="refresh-data" class="mb-6 py-3 px-6 bg-birthday-blue text-white rounded-lg hover:bg-birthday-purple transition-all touch-scale mobile-btn w-full">
      <i class="fa fa-refresh"></i> åˆ·æ–°æœ€æ–°æ•°æ®
    </button>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <div class="grid grid-cols-1 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-md border-l-4 border-birthday-yellow">
        <h3 class="text-gray-600 text-lg">æœ‰æ•ˆå®¢äººæ•°é‡</h3>
        <p id="total-guests" class="text-4xl font-bold text-birthday-pink animate-number mt-2" style="--num: 0"></p>
      </div>

      <div class="bg-white rounded-xl p-5 shadow-md border-l-4 border-birthday-blue">
        <h3 class="text-gray-600 text-lg">æœ‰æ•ˆå‡ºå¸­äººæ•°</h3>
        <p id="total-attendees" class="text-4xl font-bold text-birthday-purple animate-number mt-2" style="--num: 0"></p>
      </div>

      <!-- é‡å¤æ•°æ®ç»Ÿè®¡ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
      <div class="bg-white rounded-xl p-5 shadow-md border-l-4 border-red-400 mb-6">
        <h3 class="text-gray-600 text-lg">é‡å¤æäº¤æ•°é‡</h3>
        <p id="total-duplicates" class="text-4xl font-bold text-red-500 animate-number mt-2" style="--num: 0"></p>
      </div>
    </div>

    <!-- å®¢äººåˆ—è¡¨ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-4 bg-gray-50 border-b border-gray-200">
        <h3 class="font-bold text-lg text-gray-800">å®¢äººè¯¦æƒ…åˆ—è¡¨</h3>
        <p class="text-xs text-gray-500 mt-1">(æ ‡çº¢ä¸ºé‡å¤æäº¤ï¼Œä¸è®¡å…¥æ€»æ•°)</p>
      </div>

      <div id="guests-list" class="divide-y divide-gray-100 max-h-[50vh] overflow-y-auto">
        <div class="p-6 text-center text-gray-500">
          æ­£åœ¨åŠ è½½å®¢äººä¿¡æ¯...
        </div>
      </div>
    </div>

    <!-- è¿”å›æŒ‰é’® - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <button id="back-to-identity" class="mt-2 py-4 px-6 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all touch-scale mobile-btn w-full">
      <i class="fa fa-arrow-left"></i> è¿”å›èº«ä»½é€‰æ‹©
    </button>
  </div>
</div>

<!-- èƒŒæ™¯éŸ³ä¹å…ƒç´  -->
<audio id="birthday-music" loop preload="auto">
  <source src="http://music.163.com/song/media/outer/url?id=1325436814.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
</audio>

<script>
  // ===================== é…ç½®é¡¹ =====================
  const HOST_PASSWORD = "888888"; // é‚€è¯·äººå¯†ç 
  const BIRTHDAY_PERSON = "è‹é›¨è¾°"; // å¯¿æ˜Ÿå§“å
  const PARTY_TIME = "2025å¹´12æœˆ21æ—¥ æ™šä¸Š18:00"; // æ´¾å¯¹æ—¶é—´
  const PARTY_ADDRESS = "å¹¸ç¦è·¯88å· æ¬¢ä¹é¤å… 3æ¥¼VIPåŒ…é—´"; // æ´¾å¯¹åœ°å€
  const MAP_COORDINATES = [116.397428, 39.90923]; // åœ°å›¾åæ ‡ [ç»åº¦, çº¬åº¦]
  // ===================== å…¨å±€å˜é‡ =====================
  let attendeeCount = 1;
  let isMusicPlaying = false;
  let musicVolume = 0.7;
  let guestData = []; // æœ¬åœ°å­˜å‚¨å®¢äººæ•°æ®

  // ===================== DOMå…ƒç´  =====================
  const identityPage = document.getElementById('identity-page');
  const invitationPage = document.getElementById('invitation-page');
  const summaryPage = document.getElementById('summary-page');
  const passwordForm = document.getElementById('password-form');
  const guestsList = document.getElementById('guests-list');
  const musicElement = document.getElementById('birthday-music');
  const musicControls = document.getElementById('music-controls');
  const musicToggle = document.getElementById('music-toggle');
  const musicIcon = document.getElementById('music-icon');
  const volumeSliderContainer = document.getElementById('volume-slider-container');
  const volumeSlider = document.getElementById('volume-slider');
  const submitSuccess = document.getElementById('submit-success');
  const submitDuplicate = document.getElementById('submit-duplicate');
  const submitLoading = document.getElementById('submit-loading');
  const shareUrlEl = document.getElementById('share-url');
  const totalDuplicatesEl = document.getElementById('total-duplicates');

  // ===================== å…¼å®¹ä¸­æ–‡çš„Base64ç¼–è§£ç å‡½æ•° =====================
  function utf8ToBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function base64ToUtf8(str) {
    return decodeURIComponent(escape(atob(str)));
  }

  // ===================== æœ¬åœ°å­˜å‚¨å·¥å…·å‡½æ•° =====================
  function isDuplicateName(name) {
    const guests = JSON.parse(localStorage.getItem('birthdayGuests')) || [];
    return guests.some(item => item.name === name);
  }

  function saveGuestData(data) {
    if (isDuplicateName(data.name)) {
      throw new Error('duplicate');
    }

    let guests = JSON.parse(localStorage.getItem('birthdayGuests')) || [];
    guests.push({
      ...data,
      isDuplicate: false
    });
    localStorage.setItem('birthdayGuests', JSON.stringify(guests));
    guestData = guests;
    return true;
  }

  function loadGuestData() {
    const urlParams = new URLSearchParams(window.location.search);
    const shareData = urlParams.get('guests');

    let allGuests = [];
    if (shareData) {
      try {
        const sharedGuests = JSON.parse(base64ToUtf8(shareData));
        allGuests = sharedGuests;
      } catch (e) {
        console.log('è§£æåˆ†äº«æ•°æ®å¤±è´¥:', e);
      }
    }

    const localGuests = JSON.parse(localStorage.getItem('birthdayGuests')) || [];
    allGuests = [...allGuests, ...localGuests];

    const nameMap = new Map();
    const finalGuests = [];

    allGuests.sort((a, b) => a.time - b.time);

    allGuests.forEach(item => {
      if (!nameMap.has(item.name)) {
        nameMap.set(item.name, item);
        finalGuests.push({
          ...item,
          isDuplicate: false
        });
      } else {
        finalGuests.push({
          ...item,
          isDuplicate: true
        });
      }
    });

    guestData = finalGuests;
    localStorage.setItem('birthdayGuests', JSON.stringify(finalGuests));
    return finalGuests;
  }

  // ===================== ç”Ÿæˆåˆ†äº«é“¾æ¥ =====================
  function generateShareUrl() {
    const data = JSON.parse(localStorage.getItem('birthdayGuests')) || [];
    const dataStr = utf8ToBase64(JSON.stringify(data));
    const baseUrl = window.location.href.split('?')[0];
    return `${baseUrl}?guests=${dataStr}`;
  }

  function copyShareUrl() {
    // ç§»åŠ¨ç«¯å¤åˆ¶ä¼˜åŒ–
    navigator.clipboard.writeText(shareUrlEl.textContent).then(() => {
      alert('é“¾æ¥å¤åˆ¶æˆåŠŸï¼');
    }).catch(() => {
      // é™çº§æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
      const range = document.createRange();
      range.selectNode(shareUrlEl);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      alert('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
    });
  }

  // ===================== äº”å½©çº¸å±‘åŠ¨ç”» - ç§»åŠ¨ç«¯ä¼˜åŒ– =====================
  function initConfetti() {
    const container = document.getElementById('confetti-container');
    const colors = ['#FF6B8B', '#FFD166', '#06D6A0', '#7928CA', '#FF8C42'];

    // ç§»åŠ¨ç«¯å‡å°‘çº¸å±‘æ•°é‡ï¼Œæå‡æ€§èƒ½
    const count = window.innerWidth < 768 ? 30 : 50;

    for (let i = 0; i < count; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}vw`;
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = `${Math.random() * 5}s`;
      confetti.style.width = `${5 + Math.random() * 8}px`;
      confetti.style.height = `${5 + Math.random() * 8}px`;
      container.appendChild(confetti);
    }
  }

  // ===================== åˆå§‹åŒ–åœ°å›¾ - ç§»åŠ¨ç«¯ä¼˜åŒ– =====================
  function initMap() {
    if (typeof AMap === 'undefined') {
      document.getElementById('map-container').innerHTML = `
          <div class="w-full h-full flex items-center justify-center p-4 text-center">
            <div>
              <i class="fa fa-map-marker text-4xl text-birthday-pink mb-2"></i>
              <h3 class="font-bold text-lg">ç”Ÿæ—¥æ´¾å¯¹åœ°ç‚¹</h3>
              <p class="text-gray-600">${PARTY_ADDRESS}</p>
              <p class="text-sm text-gray-500 mt-2">è¯·ä½¿ç”¨é«˜å¾·åœ°å›¾å¯¼èˆªå‰å¾€</p>
            </div>
          </div>
        `;
      return;
    }

    const map = new AMap.Map('map-container', {
      zoom: 16,
      center: MAP_COORDINATES,
      resizeEnable: true,
      // ç§»åŠ¨ç«¯åœ°å›¾ä¼˜åŒ–
      touchZoomCenter: 0,
      keyboardEnable: false,
      doubleClickZoom: false
    });

    const marker = new AMap.Marker({
      position: MAP_COORDINATES,
      title: 'ç”Ÿæ—¥æ´¾å¯¹åœ°ç‚¹'
    });
    map.add(marker);

    const infoWindow = new AMap.InfoWindow({
      content: `<div class="font-happy"><h3 class="text-birthday-pink">ğŸ‰ ç”Ÿæ—¥æ´¾å¯¹ ğŸ‰</h3><p>${PARTY_ADDRESS}</p></div>`,
      offset: new AMap.Pixel(0, -30)
    });
    infoWindow.open(map, marker.getPosition());

    // ç§»åŠ¨ç«¯ç‚¹å‡»åœ°å›¾æ ‡è®°é‡æ–°å±…ä¸­
    marker.on('click', function() {
      map.setCenter(MAP_COORDINATES);
    });
  }

  // ===================== éŸ³ä¹æ§åˆ¶ - ç§»åŠ¨ç«¯ä¼˜åŒ– =====================
  function initMusicControls() {
    musicElement.volume = musicVolume;
    volumeSlider.value = musicVolume;

    // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
    musicToggle.addEventListener('touchstart', (e) => {
      e.preventDefault();
      musicToggle.click();
    });

    musicToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isMusicPlaying) {
        musicElement.pause();
        musicIcon.className = 'fa fa-music text-2xl';
        isMusicPlaying = false;
      } else {
        // ç§»åŠ¨ç«¯éŸ³é¢‘æ’­æ”¾ä¼˜åŒ–
        musicElement.play().catch(() => {
          // æ˜¾ç¤ºå¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨æ’­æ”¾çš„æç¤º
          alert('ğŸµ ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œè¯·ç‚¹å‡»éŸ³ä¹æŒ‰é’®æ‰‹åŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹ ğŸµ');
        });
        musicIcon.className = 'fa fa-pause text-2xl';
        isMusicPlaying = true;
      }
      volumeSliderContainer.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!musicControls.contains(e.target)) {
        volumeSliderContainer.classList.add('hidden');
      }
    });

    volumeSlider.addEventListener('input', (e) => {
      musicVolume = parseFloat(e.target.value);
      musicElement.volume = musicVolume;
    });

    musicElement.addEventListener('play', () => {
      isMusicPlaying = true;
      musicIcon.className = 'fa fa-pause text-2xl';
    });

    musicElement.addEventListener('pause', () => {
      isMusicPlaying = false;
      musicIcon.className = 'fa fa-music text-2xl';
    });
  }

  // ===================== åŠ è½½å®¢äººæ±‡æ€»æ•°æ® =====================
  function loadGuestSummary() {
    try {
      guestsList.innerHTML = `
          <div class="p-6 text-center text-gray-500">
            <i class="fa fa-spinner fa-spin text-xl mb-2"></i>
            æ­£åœ¨åŠ è½½å®¢äººä¿¡æ¯...
          </div>
        `;

      const guestData = loadGuestData();

      const validGuests = guestData.filter(item => !item.isDuplicate);
      const totalValidGuests = validGuests.length;
      const totalValidAttendees = validGuests.reduce((sum, guest) => sum + (guest.count || 1), 0);
      const totalDuplicates = guestData.filter(item => item.isDuplicate).length;

      document.getElementById('total-guests').style.setProperty('--num', totalValidGuests);
      document.getElementById('total-attendees').style.setProperty('--num', totalValidAttendees);
      totalDuplicatesEl.style.setProperty('--num', totalDuplicates);

      if (guestData.length === 0) {
        guestsList.innerHTML = `
            <div class="p-6 text-center text-gray-500">
              æš‚æ— å®¢äººä¿¡æ¯ï¼Œè¯·ç­‰å¾…å®¢äººæäº¤...
            </div>
          `;
        return;
      }

      guestsList.innerHTML = guestData.map((guest, index) => {
        const duplicateClass = guest.isDuplicate ? 'duplicate-item' : '';
        const duplicateTag = guest.isDuplicate ? '<span class="text-xs text-red-500 ml-2">(é‡å¤æäº¤)</span>' : '';

        return `
          <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-all ${duplicateClass}">
            <div>
              <p class="font-semibold text-lg text-gray-800">${guest.name}${duplicateTag}</p>
              <p class="text-gray-500 text-sm">æäº¤æ—¶é—´ï¼š${new Date(guest.time).toLocaleString()}</p>
            </div>
            <div class="bg-birthday-yellow/20 text-birthday-pink px-3 py-1 rounded-full font-bold">
              ${guest.count || 1} äºº
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('åŠ è½½å®¢äººæ•°æ®å¤±è´¥:', error);
      guestsList.innerHTML = `
          <div class="p-6 text-center text-red-500">
            <i class="fa fa-exclamation-circle text-xl mb-2"></i>
            åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°é‡è¯•
          </div>
        `;
    }
  }

  // ===================== äº‹ä»¶ç»‘å®š - ç§»åŠ¨ç«¯ä¼˜åŒ– =====================
  function bindEvents() {
    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
    function addTouchSupport(btn) {
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        btn.click();
      });
    }

    // å®¢äººæŒ‰é’®
    const guestBtn = document.getElementById('guest-btn');
    guestBtn.addEventListener('click', () => {
      identityPage.classList.add('hidden');
      invitationPage.classList.remove('hidden');
      musicControls.classList.remove('hidden');
      initConfetti();
      initMusicControls();
      setTimeout(initMap, 100);

      // ç§»åŠ¨ç«¯å»¶è¿Ÿæ’­æ”¾éŸ³ä¹ï¼Œæé«˜æˆåŠŸç‡
      setTimeout(() => {
        try {
          musicToggle.click();
        } catch (e) {}
      }, 800);
    });
    addTouchSupport(guestBtn);

    // é‚€è¯·äººæŒ‰é’®
    const hostBtn = document.getElementById('host-btn');
    hostBtn.addEventListener('click', () => {
      passwordForm.classList.toggle('hidden');
    });
    addTouchSupport(hostBtn);

    // å¯†ç éªŒè¯
    const verifyPassword = document.getElementById('verify-password');
    verifyPassword.addEventListener('click', () => {
      const password = document.getElementById('host-password').value;
      const errorMsg = document.getElementById('password-error');

      if (password === HOST_PASSWORD) {
        identityPage.classList.add('hidden');
        summaryPage.classList.remove('hidden');
        loadGuestSummary();
      } else {
        errorMsg.classList.remove('hidden');
        setTimeout(() => errorMsg.classList.add('hidden'), 3000);
      }
    });
    addTouchSupport(verifyPassword);

    // å‡ºå¸­äººæ•°è°ƒæ•´ - ç§»åŠ¨ç«¯ä¼˜åŒ–
    const decreaseBtn = document.getElementById('decrease-count');
    decreaseBtn.addEventListener('click', () => {
      if (attendeeCount > 1) {
        attendeeCount--;
        document.getElementById('attendee-count').textContent = attendeeCount;
      }
    });
    addTouchSupport(decreaseBtn);

    const increaseBtn = document.getElementById('increase-count');
    increaseBtn.addEventListener('click', () => {
      attendeeCount++;
      document.getElementById('attendee-count').textContent = attendeeCount;
    });
    addTouchSupport(increaseBtn);

    // æäº¤è¡¨å•
    document.getElementById('guest-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const guestName = document.getElementById('guest-name').value.trim();
      if (!guestName) {
        alert('è¯·è¾“å…¥æ‚¨çš„å§“åï¼');
        return;
      }

      submitSuccess.classList.add('hidden');
      submitDuplicate.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      try {
        saveGuestData({
          name: guestName,
          count: attendeeCount,
          time: Date.now()
        });

        const shareUrl = generateShareUrl();
        shareUrlEl.textContent = shareUrl;

        submitLoading.classList.add('hidden');
        submitSuccess.classList.remove('hidden');

        document.getElementById('guest-name').value = '';
        attendeeCount = 1;
        document.getElementById('attendee-count').textContent = attendeeCount;

      } catch (error) {
        submitLoading.classList.add('hidden');
        if (error.message === 'duplicate') {
          submitDuplicate.classList.remove('hidden');
          setTimeout(() => submitDuplicate.classList.add('hidden'), 3000);
        } else {
          alert('æäº¤å¤±è´¥ï¼š' + error.message);
        }
      }
    });

    // åˆ·æ–°æ•°æ®
    const refreshBtn = document.getElementById('refresh-data');
    refreshBtn.addEventListener('click', () => {
      loadGuestSummary();
    });
    addTouchSupport(refreshBtn);

    // è¿”å›æŒ‰é’®
    const backBtn = document.getElementById('back-to-identity');
    backBtn.addEventListener('click', () => {
      summaryPage.classList.add('hidden');
      identityPage.classList.remove('hidden');
      passwordForm.classList.add('hidden');
      document.getElementById('host-password').value = '';
      musicControls.classList.add('hidden');

      if (isMusicPlaying) {
        musicElement.pause();
        isMusicPlaying = false;
        musicIcon.className = 'fa fa-music text-2xl';
      }
    });
    addTouchSupport(backBtn);
  }

  // ===================== é¡µé¢åˆå§‹åŒ– =====================
  window.addEventListener('load', () => {
    // ç§»åŠ¨ç«¯é€‚é…è°ƒæ•´
    if (window.innerWidth < 768) {
      // è°ƒæ•´ç§»åŠ¨ç«¯æ ·å¼
      document.documentElement.style.fontSize = window.innerWidth / 375 * 16 + 'px';
    }

    bindEvents();

    // å¡«å……é…ç½®ä¿¡æ¯
    document.querySelectorAll('.text-birthday-purple.animate-pulse-slow').forEach(el => {
      el.textContent = BIRTHDAY_PERSON;
    });
    document.querySelectorAll('h3.text-birthday-pink').forEach(el => {
      if (el.textContent.includes('å¯¿æ˜Ÿï¼š')) {
        el.textContent = `å¯¿æ˜Ÿï¼š${BIRTHDAY_PERSON}`;
      }
    });
    document.querySelectorAll('.text-gray-600').forEach(el => {
      if (el.textContent.includes('2025å¹´8æœˆ18æ—¥ æ™šä¸Š18:00')) {
        el.textContent = PARTY_TIME;
      }
      if (el.textContent.includes('å¹¸ç¦è·¯88å· æ¬¢ä¹é¤å… 3æ¥¼VIPåŒ…é—´')) {
        el.textContent = PARTY_ADDRESS;
      }
    });

    window.copyShareUrl = copyShareUrl;

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      if (typeof AMap !== 'undefined' && document.getElementById('map-container').children.length > 0) {
        setTimeout(initMap, 100);
      }
    });
  });

  // ç§»åŠ¨ç«¯è¿”å›é”®å¤„ç†
  window.addEventListener('popstate', () => {
    if (invitationPage.classList.contains('hidden') && summaryPage.classList.contains('hidden')) return;

    if (!summaryPage.classList.contains('hidden')) {
      summaryPage.classList.add('hidden');
      identityPage.classList.remove('hidden');
    } else if (!invitationPage.classList.contains('hidden')) {
      invitationPage.classList.add('hidden');
      identityPage.classList.remove('hidden');
    }
  });
</script>
</body>
</html>